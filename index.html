<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <style>
        .annotation {
            fill: black;
            font-size: 12px;
        }
        .button {
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }
        circle {
            fill: lightblue;
            stroke: black;
        }
    </style>
</head>
<body>
    <div>
        <button class="button" onclick="showScene(1)">Scene 1</button>
        <button class="button" onclick="showScene(2)">Scene 2</button>
        <button class="button" onclick="showScene(3)">Scene 3</button>
    </div>
    <svg width="600" height="600"></svg>

    <script>
        let data;
        let svg;
        let width = 500, height = 500, margin = 50;

        async function loadData() {
            data = await d3.csv('https://flunky.github.io/cars2017.csv', d => {
                return {
                    AverageCityMPG: +d.AverageCityMPG,
                    AverageHighwayMPG: +d.AverageHighwayMPG,
                    EngineCylinders: +d.EngineCylinders
                };
            });

            svg = d3.select('svg')
                .attr('width', width + 2 * margin)
                .attr('height', height + 2 * margin)
                .append('g')
                .attr('transform', 'translate(' + margin + ',' + margin + ')');

            showScene(1);
        }

        function showScene(scene) {
            svg.html(''); // Clear the SVG content

            const x = d3.scaleLog().domain([10, 150]).range([0, width]);
            const y = d3.scaleLog().domain([10, 150]).range([height, 0]);

            svg.append('g')
                .attr('transform', 'translate(0,' + height + ')')
                .call(d3.axisBottom(x).tickValues([10, 20, 50, 100]).tickFormat(d3.format("~s")));

            svg.append('g')
                .call(d3.axisLeft(y).tickValues([10, 20, 50, 100]).tickFormat(d3.format("~s")));

            if (scene === 1) {
                showScene1(x, y);
            } else if (scene === 2) {
                showScene2(x, y);
            } else if (scene === 3) {
                showScene3(x, y);
            }
        }

        function showScene1(x, y) {
            svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(d.AverageCityMPG))
                .attr('cy', d => y(d.AverageHighwayMPG))
                .attr('r', d => 2 + d.EngineCylinders)
                .on('mouseover', function(event, d) {
                    const [x, y] = d3.pointer(event);
                    d3.select(this).attr('stroke', 'red');
                    svg.append('text')
                        .attr('x', x + 5)
                        .attr('y', y - 5)
                        .attr('class', 'tooltip')
                        .text(`MPG: ${d.AverageCityMPG}, Cylinders: ${d.EngineCylinders}`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke', 'black');
                    svg.selectAll('.tooltip').remove();
                });

            // Add annotations
            const annotations = [{
                note: { label: "City MPG vs. Highway MPG", title: "Scene 1" },
                x: x(30), y: y(30),
                dx: 50, dy: 50
            }];

            const makeAnnotations = d3.annotation()
                .annotations(annotations);

            svg.append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);
        }

        function showScene2(x, y) {
            svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(d.AverageCityMPG))
                .attr('cy', d => y(d.AverageHighwayMPG))
                .attr('r', d => 2 + d.EngineCylinders)
                .attr('fill', 'orange')
                .on('mouseover', function(event, d) {
                    const [x, y] = d3.pointer(event);
                    d3.select(this).attr('stroke', 'red');
                    svg.append('text')
                        .attr('x', x + 5)
                        .attr('y', y - 5)
                        .attr('class', 'tooltip')
                        .text(`Highway MPG: ${d.AverageHighwayMPG}`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke', 'black');
                    svg.selectAll('.tooltip').remove();
                });

            // Add annotations
            const annotations = [{
                note: { label: "Highlighting Highway MPG", title: "Scene 2" },
                x: x(50), y: y(50),
                dx: 50, dy: 50
            }];

            const makeAnnotations = d3.annotation()
                .annotations(annotations);

            svg.append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);
        }

        function showScene3(x, y) {
            svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(d.AverageCityMPG))
                .attr('cy', d => y(d.AverageHighwayMPG))
                .attr('r', d => 2 + d.EngineCylinders)
                .attr('fill', 'green')
                .on('mouseover', function(event, d) {
                    const [x, y] = d3.pointer(event);
                    d3.select(this).attr('stroke', 'red');
                    svg.append('text')
                        .attr('x', x + 5)
                        .attr('y', y - 5)
                        .attr('class', 'tooltip')
                        .text(`Cylinders: ${d.EngineCylinders}`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke', 'black');
                    svg.selectAll('.tooltip').remove();
                });

            // Add annotations
            const annotations = [{
                note: { label: "Highlighting Engine Cylinders", title: "Scene 3" },
                x: x(70), y: y(70),
                dx: 50, dy: 50
            }];

            const makeAnnotations = d3.annotation()
                .annotations(annotations);

            svg.append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);
        }

        loadData();
    </script>
</body>
</html>
