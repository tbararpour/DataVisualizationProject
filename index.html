<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-svg-annotation/2.5.1/d3-annotation.min.js"></script>
    <style>
        circle { fill: red; stroke: black; }
        .annotation { font-size: 12px; font-family: Arial, sans-serif; }
    </style>
</head>
<body onload='init()'>
    <button onclick="showBarChart()">Slide 1</button>
    <button onclick="showCircles()">Slide 2</button>
    <button onclick="showPieChart()">Slide 3</button>
    <svg width=800 height=400></svg>
    <script>
    async function init() {
        // Load and parse the CSV data
        const data = await d3.csv('https://flunky.github.io/cars2017.csv', d => {
            return {
                AverageCityMPG: +d.AverageCityMPG,
                AverageHighwayMPG: +d.AverageHighwayMPG,
                EngineCylinders: +d.EngineCylinders,
                Make: d.Make
            };
        });

        // Store the data globally
        window.chartData = data;

        // Set margins and dimensions
        const margin = {top: 50, right: 150, bottom: 150, left: 50};
        const width = 600;
        const height = 300;

        // Create scales for bar chart
        window.x0 = d3.scaleBand()
                      .domain(data.map(d => d.Make))
                      .range([0, width])
                      .padding(0.1);

        window.x1 = d3.scaleBand()
                      .domain([...new Set(data.map(d => d.EngineCylinders))])
                      .range([0, x0.bandwidth()])
                      .padding(0.05);

        window.yBar = d3.scaleLinear()
                     .domain([0, d3.max(data, d => d.AverageHighwayMPG)])
                     .range([height, 0]);

        window.color = d3.scaleOrdinal(d3.schemeCategory10);

        // Create scales for bubble chart
        window.xBubble = d3.scaleLog()
                    .domain([10, 150])
                    .range([0, width])
                    .base(10);

        window.yBubble = d3.scaleLog()
                    .domain([10, 150])
                    .range([height, 0])
                    .base(10);

        // Create SVG canvas
        window.svg = d3.select('svg')
                      .attr('width', width + margin.left + margin.right)
                      .attr('height', height + margin.top + margin.bottom)
                      .append('g')
                      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        // Add x-axis
        const xAxis = d3.axisBottom(x0);

        svg.append('g')
           .attr('transform', 'translate(0,' + height + ')')
           .call(xAxis)
           .selectAll("text")
           .attr("y", 0)
           .attr("x", 9)
           .attr("dy", ".35em")
           .attr("transform", "rotate(45)")
           .style("text-anchor", "start");

        // Add y-axis
        const yAxis = d3.axisLeft(yBar);

        svg.append('g')
           .call(yAxis);

        // Show bar chart by default
        showBarChart();
    }

    function createAnnotations() {
        // Define annotations
        const annotations = [
            {
                note: {
                    label: "This is a high efficiency vehicle",
                    title: "High Efficiency",
                    wrap: 200
                },
                x: window.x0("BMW"),
                y: window.yBar(50),
                dy: -30,
                dx: 30
            },
            {
                note: {
                    label: "This vehicle has a lot of cylinders",
                    title: "High Cylinders",
                    wrap: 200
                },
                x: window.x0("Ford"),
                y: window.yBar(30),
                dy: -30,
                dx: 30
            }
        ];

        const makeAnnotations = d3.annotation()
            .type(d3.annotationLabel)
            .annotations(annotations);

        window.svg.append("g")
            .attr("class", "annotation-group")
            .call(makeAnnotations);
    }

    function showBarChart() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Redraw axes
        const xAxis = d3.axisBottom(x0);

        svg.append('g')
           .attr('transform', 'translate(0,' + 300 + ')')
           .call(xAxis)
           .selectAll("text")
           .attr("y", 0)
           .attr("x", 9)
           .attr("dy", ".35em")
           .attr("transform", "rotate(45)")
           .style("text-anchor", "start");

        const yAxis = d3.axisLeft(yBar);

        svg.append('g')
           .call(yAxis);

        // Aggregate data for the bar chart
        const nestedData = d3.nest()
            .key(d => d.Make)
            .key(d => d.EngineCylinders)
            .rollup(values => d3.mean(values, d => d.AverageHighwayMPG))
            .entries(chartData);

        // Add bars
        const bars = svg.selectAll(".bar")
                        .data(nestedData)
                        .enter()
                        .append("g")
                        .attr("class", "bar")
                        .attr("transform", d => `translate(${x0(d.key)},0)`);

        bars.selectAll("rect")
            .data(d => d.values)
            .enter()
            .append("rect")
            .attr("x", d => x1(d.key))
            .attr("y", d => yBar(d.value))
            .attr("width", x1.bandwidth())
            .attr("height", d => 300 - yBar(d.value))
            .style("fill", d => color(d.key));

        // Add legend
        const legend = svg.selectAll(".legend")
                          .data(x1.domain())
                          .enter()
                          .append("g")
                          .attr("class", "legend")
                          .attr("transform", (d, i) => `translate(${600 + 20}, ${i * 20})`);

        legend.append("rect")
              .attr("x", 0)
              .attr("width", 18)
              .attr("height", 18)
              .style("fill", d => color(d));

        legend.append("text")
              .attr("x", 24)
              .attr("y", 9)
              .attr("dy", ".35em")
              .style("text-anchor", "start")
              .text(d => `${d} cylinders`);

        // Add annotations
        createAnnotations();
    }

    function showCircles() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Redraw axes
        const xAxis = d3.axisBottom(xBubble)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .attr('transform', 'translate(0,' + 300 + ')')
           .call(xAxis);

        const yAxis = d3.axisLeft(yBubble)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .call(yAxis);

        // Add circles
        svg.selectAll('circle')
           .data(chartData)
           .enter()
           .append('circle')
           .attr('cx', d => xBubble(d.AverageCityMPG))
           .attr('cy', d => yBubble(d.AverageHighwayMPG))
           .attr('r', d => 2 + d.EngineCylinders)
           .style('fill', 'red');

        // Add annotations
        createAnnotations();
    }

    function showPieChart() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Aggregate data for the pie chart
        const aggregatedData = d3.nest()
            .key(d => d.Make)
            .rollup(values => d3.sum(values, d => d.EngineCylinders))
            .entries(chartData);

        const sortedData = aggregatedData.sort((a, b) => b.value - a.value);

        const topData = sortedData.slice(0, 10);
        const otherData = {
            key: "Others",
            value: d3.sum(sortedData.slice(10), d => d.value)
        };

        const pieData = topData.concat(otherData);

        const pie = d3.pie()
                      .value(d => d.value);

        const arc = d3.arc()
                      .innerRadius(0)
                      .outerRadius(100);

        const pieArcs = pie(pieData);

        const arcs = svg.selectAll(".arc")
                        .data(pieArcs)
                        .enter()
                        .append("g")
                        .attr("class", "arc")
                        .attr("transform", `translate(${window.width / 2}, ${window.height / 2})`);

        arcs.append("path")
            .attr("d", arc)
            .style("fill", (d, i) => color(i));

        arcs.append("text")
            .attr("transform", d => `translate(${arc.centroid(d)})`)
            .attr("dy", "0.35em")
            .text(d => d.data.key);

        // Add annotations
        createAnnotations();
    }

    </script>
</body>
</html>
