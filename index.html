<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        circle { stroke: black; }
        .annotation { font-size: 12px; font-family: Arial, sans-serif; }
    </style>
</head>
<body onload='init()'>
    <button onclick="showBarChart()">Slide 1</button>
    <button onclick="showCircles()">Slide 2</button>
    <button onclick="showStackedBarChart()">Slide 3</button>
    <svg width=1200 height=600></svg>
    <script>
    async function init() {
        // Load and parse the CSV data
        const data = await d3.csv('https://flunky.github.io/cars2017.csv', function(d) {
            return {
                AverageCityMPG: +d.AverageCityMPG,
                AverageHighwayMPG: +d.AverageHighwayMPG,
                EngineCylinders: +d.EngineCylinders,
                Make: d.Make,
                Fuel: d.Fuel
            };
        });

        // Store the data globally
        window.chartData = data;

        // Set margins and dimensions
        const margin = {top: 70, right: 150, bottom: 70, left: 70};
        const width = 1200; // 1300 - margins
        const height = 400; // 500 - margins

        // Store dimensions globally
        window.width = width;
        window.height = height;

        // Create SVG canvas
        window.svg = d3.select('svg')
                      .attr('width', width + margin.left + margin.right)
                      .attr('height', height + margin.top + margin.bottom)
                      .append('g')
                      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        // Show bar chart by default
        showBarChart();
    }

    function createAnnotationsBarChart() {
        // Define annotations
        const annotations = [
            {
                note: {
                    label: "Vehicles with 0 cylinders (electrical vehicles) have the highest speed",
                    title: "Highest Highway Speed",
                    wrap: 150
                },
                x: window.x0("BMW"),
                y: window.yBar(110),
                dy: 0,
                dx: 0
            }
        ];

        const annotationGroup = window.svg.append("g")
            .attr("class", "annotation-group");

        annotationGroup.selectAll("text")
            .data(annotations)
            .enter()
            .append("text")
            .attr("class", "annotation")
            .attr("x", function(d) { return d.x + d.dx; })
            .attr("y", function(d) { return d.y + d.dy; })
            .text(function(d) { return d.note.title + ": " + d.note.label; });
    }

function createAnnotationsCircles() {
        // Define annotations
        const annotations = [
            {
                note: {
                    label: "Vehicles with higher number\nof cylinders usually have lower speeds",
                    title: "# of Cylinders vs Speed",
                    wrap: 1
                },
                x: window.xBubble(11),
                y: window.yBubble(40),
                dy: 0,
                dx: 0
            },
            {
                note: {
                    label: "Electric vehicles have the highest\nspeeds compared to gasoline and diesel vehicles.",
                    title: "# of Cylinders vs Speed",
                    wrap: 1
                },
                x: window.xBubble(70),
                y: window.yBubble(60),
                dy: 0,
                dx: 0
            }
        ];

        const annotationGroup = window.svg.append("g")
            .attr("class", "annotation-group");

        annotationGroup.selectAll("text")
            .data(annotations)
            .enter()
            .append("text")
            .attr("class", "annotation")
            .attr("x", function(d) { return d.x + d.dx; })
            .attr("y", function(d) { return d.y + d.dy; })
            .text(function(d) { return d.note.title + ": " + d.note.label; });
    }

function createAnnotationsStackedBarChart() {
        // Define annotations
        const annotations = [
            {
                note: {
                    label: "Vehicles with 0 cylinders\n(electrical vehicles) have the highest speed",
                    title: "Highest Highway Speed",
                    wrap: 150
                },
                x: 30,
                y: 50,
                dy: 0,
                dx: 0
            }
        ];

        const annotationGroup = window.svg.append("g")
            .attr("class", "annotation-group");

        annotationGroup.selectAll("text")
            .data(annotations)
            .enter()
            .append("text")
            .attr("class", "annotation")
            .attr("x", function(d) { return d.x + d.dx; })
            .attr("y", function(d) { return d.y + d.dy; })
            .text(function(d) { return d.note.title + ": " + d.note.label; });
    }

    
    function showBarChart() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();



        // Create scales for bar chart
        var makes = chartData.map(function(d) { return d.Make; }); // Extract the 'Make' values
        x0 = d3.scaleBand()
                      .domain(makes) // Set the domain to the 'Make' values
                      .range([0, width]) // Set the range to span the chart width
                      .paddingInner(0.1); // Add padding between the bands

        x1 = d3.scaleBand()
                      .domain(chartData.map(function(d) { return d.EngineCylinders; }).filter(function(value, index, self) {
                          return self.indexOf(value) === index;
                      }).sort(function(a, b) { return a - b; }))
                      .range([0, x0.bandwidth()])
                      .padding(0.05);

        yBar = d3.scaleLinear()
                     .domain([0, d3.max(chartData, function(d) { return d.AverageHighwayMPG; })])
                     .range([height, 0]);

        color = d3.scaleOrdinal(d3.schemeCategory10);
        
        // Add title
        svg.append("text")
           .attr("x", width / 2)
           .attr("y", -30)
           .attr("text-anchor", "middle")
           .style("font-size", "20px")
           .style("font-weight", "bold")
           .text("Bar Chart: Average Highway MPG by Make and Cylinders");

        // Redraw axes
        const xAxis = d3.axisBottom(x0);

        svg.append('g')
           .attr('transform', 'translate(0,' + height + ')')
           .call(xAxis)
           .selectAll("text")
           .attr("y", 0)
           .attr("x", 9)
           .attr("dy", ".35em")
           .attr("transform", "rotate(45)")
           .style("text-anchor", "start");

        svg.append('text')
           .attr('x', width / 2)
           .attr('y', height + 60)
           .attr('text-anchor', 'middle')
           .style('font-size', '14px')
           .text('Make');

        const yAxis = d3.axisLeft(yBar);

        svg.append('g')
           .call(yAxis);

        svg.append('text')
           .attr('transform', 'rotate(-90)')
           .attr('x', -height / 2)
           .attr('y', -60)
           .attr('text-anchor', 'middle')
           .style('font-size', '14px')
           .text('Average Highway MPG');

        // Aggregate data for the bar chart
        const nestedData = d3.nest()
            .key(function(d) { return d.Make; })
            .key(function(d) { return d.EngineCylinders; })
            .rollup(function(values) { return d3.mean(values, function(d) { return d.AverageHighwayMPG; }); })
            .entries(chartData);

        // Add bars
        const bars = svg.selectAll(".bar")
                        .data(nestedData)
                        .enter()
                        .append("g")
                        .attr("class", "bar")
                        .attr("transform", function(d) { return `translate(${x0(d.key)},0)`; });

        bars.selectAll("rect")
            .data(function(d) { return d.values; })
            .enter()
            .append("rect")
            .attr("x", function(d) { return x1(d.key); })
            .attr("y", function(d) { return yBar(d.value); })
            .attr("width", x1.bandwidth())
            .attr("height", function(d) { return height - yBar(d.value); })
            .style("fill", function(d) { return color(d.key); });

        // Add legend title
        svg.append("text")
            .attr("class", "legend-title")
            .attr("x", width + 20)
            .attr("y", -10)
            .attr("text-anchor", "start")
            .style("font-weight", "bold")
            .text("Cylinders");

        // Add legend
        const legend = svg.selectAll(".legend")
                          .data(x1.domain().sort(function(a, b) { return a - b; })) // Sort legend items by cylinder count
                          .enter()
                          .append("g")
                          .attr("class", "legend")
                          .attr("transform", function(d, i) { return `translate(${width + 20}, ${i * 20})`; });

        legend.append("rect")
              .attr("x", 0)
              .attr("width", 18)
              .attr("height", 18)
              .style("fill", function(d) { return color(d); });

        legend.append("text")
              .attr("x", 24)
              .attr("y", 9)
              .attr("dy", ".35em")
              .style("text-anchor", "start")
              .text(function(d) { return `${d} cylinders`; });

        // Add annotations
        createAnnotationsBarChart();
    }

    function showCircles() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Create scales for bubble chart
        xBubble = d3.scaleLog()
                    .domain([10, 150])
                    .range([0, width * 0.75])
                    .base(10);

        yBubble = d3.scaleLog()
                    .domain([10, 150])
                    .range([height * 0.75, 0])
                    .base(10);
        
        // Add title
        svg.append("text")
           .attr("x", (width * 0.75) / 2)
           .attr("y", -30)
           .attr("text-anchor", "middle")
           .style("font-size", "20px")
           .style("font-weight", "bold")
           .text("Bubble Chart: City MPG vs Highway MPG by Fuel Type");

        // Draw axes
        const xAxis = d3.axisBottom(xBubble)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .attr('transform', 'translate(0,' + height * 0.75 + ')')
           .call(xAxis);

        svg.append('text')
           .attr('x', (width * 0.75) / 2)
           .attr('y', height * 0.75 + 60)
           .attr('text-anchor', 'middle')
           .style('font-size', '14px')
           .text('Average City MPG');

        const yAxis = d3.axisLeft(yBubble)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .call(yAxis);

        svg.append('text')
           .attr('transform', 'rotate(-90)')
           .attr('x', -(height * 0.75) / 2)
           .attr('y', -60)
           .attr('text-anchor', 'middle')
           .style('font-size', '14px')
           .text('Average Highway MPG');

        // Add circles
        svg.selectAll('circle')
           .data(chartData)
           .enter()
           .append('circle')
           .attr('cx', function(d) { return xBubble(d.AverageCityMPG); })
           .attr('cy', function(d) { return yBubble(d.AverageHighwayMPG); })
           .attr('r', function(d) { return 2 + d.EngineCylinders; })
           .style('fill', function(d) {
               if (d.Fuel === 'Electricity') return 'green';
               if (d.Fuel === 'Diesel') return 'brown';
               if (d.Fuel === 'Gasoline') return 'blue';
               return 'gray'; // default color if Fuel is something else
           });

        // Add legend for Fuel types
        svg.append("text")
            .attr("class", "legend-title")
            .attr("x", width * 0.75 + 20)
            .attr("y", -10)
            .attr("text-anchor", "start")
            .style("font-weight", "bold")
            .text("Fuel Types");

        const fuels = ['Electricity', 'Diesel', 'Gasoline'];
        const fuelColors = ['green', 'brown', 'blue'];

        const legendFuel = svg.selectAll(".legendFuel")
                              .data(fuels)
                              .enter()
                              .append("g")
                              .attr("class", "legendFuel")
                              .attr("transform", function(d, i) { return `translate(${width * 0.75 + 20}, ${i * 20})`; });

        legendFuel.append("rect")
                  .attr("x", 0)
                  .attr("width", 18)
                  .attr("height", 18)
                  .style("fill", function(d, i) { return fuelColors[i]; });

        legendFuel.append("text")
                  .attr("x", 24)
                  .attr("y", 9)
                  .attr("dy", ".35em")
                  .style("text-anchor", "start")
                  .text(function(d) { return d; });

        // Add annotations
        createAnnotationsCircles();
    }

    function showStackedBarChart() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Add title
        svg.append("text")
           .attr("x", width / 2)
           .attr("y", -30)
           .attr("text-anchor", "middle")
           .style("font-size", "20px")
           .style("font-weight", "bold")
           .text("Stacked Bar Chart: Number of Records by Cylinders and Fuel Type");

        // Aggregate data for the stacked bar chart
        const nestedData = d3.nest()
            .key(function(d) { return d.EngineCylinders; })
            .key(function(d) { return d.Fuel; })
            .rollup(function(values) { return values.length; })
            .entries(chartData);

        // Prepare data for stacking
        const fuels = ['Electricity', 'Diesel', 'Gasoline'];
        const stackData = nestedData.map(function(d) {
            const obj = { EngineCylinders: d.key };
            d.values.forEach(function(v) {
                obj[v.key] = v.value;
            });
            return obj;
        });

        const stack = d3.stack()
            .keys(fuels)
            .value(function(d, key) { return d[key] || 0; });

        const series = stack(stackData);

        // Create scales
        const xStacked = d3.scaleBand()
            .domain(stackData.map(function(d) { return d.EngineCylinders; }).sort(function(a, b) { return a - b; }))
            .range([0, width * 0.75])
            .padding(0.1);

        const yStacked = d3.scaleLinear()
            .domain([0, d3.max(stackData, function(d) { return d3.sum(fuels.map(function(f) { return d[f] || 0; })); })])
            .range([height * 0.75, 0]);

        const colorStacked = d3.scaleOrdinal()
            .domain(fuels)
            .range(['green', 'brown', 'blue']);

        // Redraw axes
        const xAxis = d3.axisBottom(xStacked);

        svg.append('g')
            .attr('transform', 'translate(0,' + height * 0.75 + ')')
            .call(xAxis)
            .selectAll("text")
            .attr("y", 0)
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(45)")
            .style("text-anchor", "start");

        svg.append('text')
           .attr('x', (width * 0.75) / 2)
           .attr('y', height * 0.75 + 60)
           .attr('text-anchor', 'middle')
           .style('font-size', '14px')
           .text('Engine Cylinders');

        const yAxis = d3.axisLeft(yStacked);

        svg.append('g')
            .call(yAxis);

        svg.append('text')
           .attr('transform', 'rotate(-90)')
           .attr('x', -(height * 0.75) / 2)
           .attr('y', -60)
           .attr('text-anchor', 'middle')
           .style('font-size', '14px')
           .text('Number of Records');

        // Add bars
        svg.append('g')
            .selectAll('g')
            .data(series)
            .enter()
            .append('g')
            .attr('fill', function(d) { return colorStacked(d.key); })
            .selectAll('rect')
            .data(function(d) { return d; })
            .enter()
            .append('rect')
            .attr('x', function(d) { return xStacked(d.data.EngineCylinders); })
            .attr('y', function(d) { return yStacked(d[1]); })
            .attr('height', function(d) { return yStacked(d[0]) - yStacked(d[1]); })
            .attr('width', xStacked.bandwidth());

        // Add legend title
        svg.append("text")
            .attr("class", "legend-title")
            .attr("x", (width * 0.75) + 20)
            .attr("y", -10)
            .attr("text-anchor", "start")
            .style("font-weight", "bold")
            .text("Fuel Types");

        // Add legend
        const legend = svg.selectAll(".legend")
            .data(fuels)
            .enter()
            .append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) { return `translate(${(width * 0.75) + 20}, ${i * 20})`; });

        legend.append("rect")
            .attr("x", 0)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", function(d) { return colorStacked(d); });

        legend.append("text")
            .attr("x", 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) { return d; });

        // Add annotations
        createAnnotationsStackedBarChart();
    }

    </script>
</body>
</html>
