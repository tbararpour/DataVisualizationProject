<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-svg-annotation/2.5.1/d3-annotation.min.js"></script>
    <style>
        circle { stroke: black; }
        .triangle { fill: blue; stroke: black; }
        .annotation { font-size: 12px; font-family: Arial, sans-serif; }
    </style>
</head>
<body onload='init()'>
    <button onclick="showCircles()">Slide 1</button>
    <button onclick="showTriangles()">Slide 2</button>
    <button onclick="showPieChart()">Slide 3</button>
    <svg width=600 height=400></svg>
    <script>
    async function init() {
        // Load and parse the CSV data
        const data = await d3.csv('https://flunky.github.io/cars2017.csv', d => {
            return {
                AverageCityMPG: +d.AverageCityMPG,
                AverageHighwayMPG: +d.AverageHighwayMPG,
                EngineCylinders: +d.EngineCylinders,
                EngineDisplacement: +d.EngineDisplacement,
                Horsepower: +d.Horsepower,
                Make: d.Make
            };
        });

        // Store the data globally
        window.chartData = data;

        // Set margins and dimensions
        const margin = {top: 50, right: 50, bottom: 50, left: 50};
        const width = 500;
        const height = 300;

        // Create scales
        window.x = d3.scaleLog()
                    .domain([10, 150])
                    .range([0, width])
                    .base(10);

        window.y = d3.scaleLog()
                    .domain([10, 150])
                    .range([height, 0])
                    .base(10);

        window.size = d3.scaleLinear()
                       .domain(d3.extent(data, d => d.EngineCylinders))
                       .range([5, 20]);

        window.color = d3.scaleOrdinal(d3.schemeCategory10);

        // Create SVG canvas
        window.svg = d3.select('svg')
                      .attr('width', width + margin.left + margin.right)
                      .attr('height', height + margin.top + margin.bottom)
                      .append('g')
                      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        // Add x-axis
        const xAxis = d3.axisBottom(x)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .attr('transform', 'translate(0,' + height + ')')
           .call(xAxis);

        // Add y-axis
        const yAxis = d3.axisLeft(y)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .call(yAxis);

        // Show bubbles by default
        showCircles();
    }

    function createAnnotations() {
        // Define annotations
        const annotations = [
            {
                note: {
                    label: "This is a high efficiency vehicle",
                    title: "High Efficiency",
                    wrap: 200
                },
                x: window.x(50),
                y: window.y(50),
                dy: -30,
                dx: 30
            },
            {
                note: {
                    label: "This vehicle has a lot of cylinders",
                    title: "High Cylinders",
                    wrap: 200
                },
                x: window.x(15),
                y: window.y(30),
                dy: -30,
                dx: 30
            }
        ];

        const makeAnnotations = d3.annotation()
            .type(d3.annotationLabel)
            .annotations(annotations);

        window.svg.append("g")
            .attr("class", "annotation-group")
            .call(makeAnnotations);
    }

    function showCircles() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Redraw axes
        const xAxis = d3.axisBottom(x)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .attr('transform', 'translate(0,' + 300 + ')')
           .call(xAxis);

        const yAxis = d3.axisLeft(y)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .call(yAxis);

        // Add bubbles
        svg.selectAll('circle')
           .data(chartData)
           .enter()
           .append('circle')
           .attr('cx', d => x(d.EngineDisplacement))
           .attr('cy', d => y(d.Horsepower))
           .attr('r', d => size(d.EngineCylinders))
           .style('fill', d => color(d.Make))
           .append('title')  // Tooltip
           .text(d => `${d.Make}\nEngine Displacement: ${d.EngineDisplacement}\nHorsepower: ${d.Horsepower}\nEngine Cylinders: ${d.EngineCylinders}`);

        // Add annotations
        createAnnotations();
    }

    function showTriangles() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Redraw axes
        const xAxis = d3.axisBottom(x)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .attr('transform', 'translate(0,' + 300 + ')')
           .call(xAxis);

        const yAxis = d3.axisLeft(y)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .call(yAxis);

        // Add triangles
        svg.selectAll('.triangle')
           .data(chartData)
           .enter()
           .append('path')
           .attr('class', 'triangle')
           .attr('d', d3.symbol().type(d3.symbolTriangle).size(d => (2 + d.EngineCylinders) * 20))
           .attr('transform', d => `translate(${x(d.AverageCityMPG)},${y(d.AverageHighwayMPG)})`)
           .style('fill', 'blue');

        // Add annotations
        createAnnotations();
    }

    function showPieChart() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        const pie = d3.pie()
                      .value(d => d.EngineCylinders);

        const arc = d3.arc()
                      .innerRadius(0)
                      .outerRadius(100);

        const pieData = pie(chartData);

        const arcs = svg.selectAll(".arc")
                        .data(pieData)
                        .enter()
                        .append("g")
                        .attr("class", "arc")
                        .attr("transform", `translate(${window.width / 2}, ${window.height / 2})`);

        arcs.append("path")
            .attr("d", arc)
            .style("fill", (d, i) => color(i));

        arcs.append("text")
            .attr("transform", d => `translate(${arc.centroid(d)})`)
            .attr("dy", "0.35em")
            .text(d => d.data.Make);

        // Add annotations
        createAnnotations();
    }

    </script>
</body>
</html>
