<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-svg-annotation/2.5.1/d3-annotation.min.js"></script>
    <style>
        circle { stroke: black; }
        .annotation { font-size: 12px; font-family: Arial, sans-serif; }
    </style>
</head>
<body onload='init()'>
    <button onclick="showBarChart()">Slide 1</button>
    <button onclick="showCircles()">Slide 2</button>
    <button onclick="showStackedBarChart()">Slide 3</button>
    <svg width=1200 height=500></svg>
    <script>
    async function init() {
        // Load and parse the CSV data
        const data = await d3.csv('https://flunky.github.io/cars2017.csv', d => {
            return {
                AverageCityMPG: +d.AverageCityMPG,
                AverageHighwayMPG: +d.AverageHighwayMPG,
                EngineCylinders: +d.EngineCylinders,
                Make: d.Make,
                Fuel: d.Fuel
            };
        });

        // Store the data globally
        window.chartData = data;

        // Set margins and dimensions
        const margin = {top: 50, right: 50, bottom: 50, left: 50};
        const width = 1100; // 1200 - margins
        const height = 400; // 500 - margins

        // Store dimensions globally
        window.width = width;
        window.height = height;

        // Create scales for bar chart
        window.x0 = d3.scaleBand()
                      .domain(data.map(d => d.Make))
                      .range([0, width])
                      .padding(0.1);

        window.x1 = d3.scaleBand()
                      .domain([...new Set(data.map(d => d.EngineCylinders))].sort((a, b) => a - b))
                      .range([0, x0.bandwidth()])
                      .padding(0.05);

        window.yBar = d3.scaleLinear()
                     .domain([0, d3.max(data, d => d.AverageHighwayMPG)])
                     .range([height, 0]);

        window.color = d3.scaleOrdinal(d3.schemeCategory10);

        // Create scales for bubble chart
        window.xBubble = d3.scaleLog()
                    .domain([10, 150])
                    .range([0, width])
                    .base(10);

        window.yBubble = d3.scaleLog()
                    .domain([10, 150])
                    .range([height, 0])
                    .base(10);

        // Create SVG canvas
        window.svg = d3.select('svg')
                      .attr('width', width + margin.left + margin.right)
                      .attr('height', height + margin.top + margin.bottom)
                      .append('g')
                      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        // Add x-axis
        const xAxis = d3.axisBottom(x0);

        svg.append('g')
           .attr('transform', 'translate(0,' + height + ')')
           .call(xAxis)
           .selectAll("text")
           .attr("y", 0)
           .attr("x", 9)
           .attr("dy", ".35em")
           .attr("transform", "rotate(45)")
           .style("text-anchor", "start");

        // Add y-axis
        const yAxis = d3.axisLeft(yBar);

        svg.append('g')
           .call(yAxis);

        // Show bar chart by default
        showBarChart();
    }

    function createAnnotations() {
        // Define annotations
        const annotations = [
            {
                note: {
                    label: "This is a high efficiency vehicle",
                    title: "High Efficiency",
                    wrap: 200
                },
                x: window.x0("BMW"),
                y: window.yBar(50),
                dy: -30,
                dx: 30
            },
            {
                note: {
                    label: "This vehicle has a lot of cylinders",
                    title: "High Cylinders",
                    wrap: 200
                },
                x: window.x0("Ford"),
                y: window.yBar(30),
                dy: -30,
                dx: 30
            }
        ];

        const makeAnnotations = d3.annotation()
            .type(d3.annotationLabel)
            .annotations(annotations);

        window.svg.append("g")
            .attr("class", "annotation-group")
            .call(makeAnnotations);
    }

    function showBarChart() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Redraw axes
        const xAxis = d3.axisBottom(x0);

        svg.append('g')
           .attr('transform', 'translate(0,' + height + ')')
           .call(xAxis)
           .selectAll("text")
           .attr("y", 0)
           .attr("x", 9)
           .attr("dy", ".35em")
           .attr("transform", "rotate(45)")
           .style("text-anchor", "start");

        const yAxis = d3.axisLeft(yBar);

        svg.append('g')
           .call(yAxis);

        // Aggregate data for the bar chart
        const nestedData = d3.nest()
            .key(d => d.Make)
            .key(d => d.EngineCylinders)
            .rollup(values => d3.mean(values, d => d.AverageHighwayMPG))
            .entries(chartData);

        // Add bars
        const bars = svg.selectAll(".bar")
                        .data(nestedData)
                        .enter()
                        .append("g")
                        .attr("class", "bar")
                        .attr("transform", d => `translate(${x0(d.key)},0)`);

        bars.selectAll("rect")
            .data(d => d.values)
            .enter()
            .append("rect")
            .attr("x", d => x1(d.key))
            .attr("y", d => yBar(d.value))
            .attr("width", x1.bandwidth())
            .attr("height", d => height - yBar(d.value))
            .style("fill", d => color(d.key));

        // Add legend title
        svg.append("text")
            .attr("class", "legend-title")
            .attr("x", width + 20)
            .attr("y", -10)
            .attr("text-anchor", "start")
            .style("font-weight", "bold")
            .text("Cylinders");

        // Add legend
        const legend = svg.selectAll(".legend")
                          .data(x1.domain().sort((a, b) => a - b)) // Sort legend items by cylinder count
                          .enter()
                          .append("g")
                          .attr("class", "legend")
                          .attr("transform", (d, i) => `translate(${width + 20}, ${i * 20})`);

        legend.append("rect")
              .attr("x", 0)
              .attr("width", 18)
              .attr("height", 18)
              .style("fill", d => color(d));

        legend.append("text")
              .attr("x", 24)
              .attr("y", 9)
              .attr("dy", ".35em")
              .style("text-anchor", "start")
              .text(d => `${d} cylinders`);

        // Add annotations
        createAnnotations();
    }

    function showCircles() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Redraw axes
        const xAxis = d3.axisBottom(xBubble)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .attr('transform', 'translate(0,' + height + ')')
           .call(xAxis);

        const yAxis = d3.axisLeft(yBubble)
                        .tickValues([10, 20, 50, 100])
                        .tickFormat(d3.format("~s"));

        svg.append('g')
           .call(yAxis);

        // Add circles
        svg.selectAll('circle')
           .data(chartData)
           .enter()
           .append('circle')
           .attr('cx', d => xBubble(d.AverageCityMPG))
           .attr('cy', d => yBubble(d.AverageHighwayMPG))
           .attr('r', d => 2 + d.EngineCylinders)
           .style('fill', d => {
               if (d.Fuel === 'Electricity') return 'green';
               if (d.Fuel === 'Diesel') return 'brown';
               if (d.Fuel === 'Gasoline') return 'blue';
               return 'gray'; // default color if Fuel is something else
           });

        // Add legend for Fuel types
        svg.append("text")
            .attr("class", "legend-title")
            .attr("x", width + 20)
            .attr("y", -10)
            .attr("text-anchor", "start")
            .style("font-weight", "bold")
            .text("Fuel Types");

        const fuels = ['Electricity', 'Diesel', 'Gasoline'];
        const fuelColors = ['green', 'brown', 'blue'];

        const legendFuel = svg.selectAll(".legendFuel")
                              .data(fuels)
                              .enter()
                              .append("g")
                              .attr("class", "legendFuel")
                              .attr("transform", (d, i) => `translate(${width + 20}, ${i * 20})`);

        legendFuel.append("rect")
                  .attr("x", 0)
                  .attr("width", 18)
                  .attr("height", 18)
                  .style("fill", (d, i) => fuelColors[i]);

        legendFuel.append("text")
                  .attr("x", 24)
                  .attr("y", 9)
                  .attr("dy", ".35em")
                  .style("text-anchor", "start")
                  .text(d => d);

        // Add annotations
        createAnnotations();
    }

    function showStackedBarChart() {
        // Clear existing shapes and annotations
        svg.selectAll("*").remove();

        // Aggregate data for the stacked bar chart
        const nestedData = d3.nest()
            .key(d => d.EngineCylinders)
            .key(d => d.Fuel)
            .rollup(values => values.length)
            .entries(chartData);

        // Prepare data for stacking
        const fuels = ['Electricity', 'Diesel', 'Gasoline'];
        const stackData = nestedData.map(d => {
            const obj = { EngineCylinders: d.key };
            d.values.forEach(v => {
                obj[v.key] = v.value;
            });
            return obj;
        });

        const stack = d3.stack()
            .keys(fuels)
            .value((d, key) => d[key] || 0);

        const series = stack(stackData);

        // Create scales
        const xStacked = d3.scaleBand()
            .domain(stackData.map(d => d.EngineCylinders))
            .range([0, width])
            .padding(0.1);

        const yStacked = d3.scaleLinear()
            .domain([0, d3.max(stackData, d => d3.sum(fuels.map(f => d[f] || 0)))])
            .range([height, 0]);

        const colorStacked = d3.scaleOrdinal()
            .domain(fuels)
            .range(['green', 'brown', 'blue']);

        // Redraw axes
        const xAxis = d3.axisBottom(xStacked);

        svg.append('g')
            .attr('transform', 'translate(0,' + height + ')')
            .call(xAxis)
            .selectAll("text")
            .attr("y", 0)
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(45)")
            .style("text-anchor", "start");

        const yAxis = d3.axisLeft(yStacked);

        svg.append('g')
            .call(yAxis);

        // Add bars
        svg.append('g')
            .selectAll('g')
            .data(series)
            .enter()
            .append('g')
            .attr('fill', d => colorStacked(d.key))
            .selectAll('rect')
            .data(d => d)
            .enter()
            .append('rect')
            .attr('x', d => xStacked(d.data.EngineCylinders))
            .attr('y', d => yStacked(d[1]))
            .attr('height', d => yStacked(d[0]) - yStacked(d[1]))
            .attr('width', xStacked.bandwidth());

        // Add legend title
        svg.append("text")
            .attr("class", "legend-title")
            .attr("x", width + 20)
            .attr("y", -10)
            .attr("text-anchor", "start")
            .style("font-weight", "bold")
            .text("Fuel Types");

        // Add legend
        const legend = svg.selectAll(".legend")
            .data(fuels)
            .enter()
            .append("g")
            .attr("class", "legend")
            .attr("transform", (d, i) => `translate(${width + 20}, ${i * 20})`);

        legend.append("rect")
            .attr("x", 0)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", d => colorStacked(d));

        legend.append("text")
            .attr("x", 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(d => d);

        // Add annotations
        createAnnotations();
    }

    </script>
</body>
</html>
